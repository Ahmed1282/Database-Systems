create table EMP(
	EMPNO NUMERIC(4) NOT NULL, 
	ENAME VARCHAR(10),
	JOB VARCHAR(9),
	MGR NUMERIC(4),
	HIRDATE DATE,
	SAL NUMERIC(7,2),
	COMM NUMERIC(7,2),
	DEPTINO NUMERIC(2));

INSERT INTO EMP VALUES
(7369, 'SMITH', 'CLERK',7902, CONVERT(date, '17-DEC-1980'), 800, NULL, 20); INSERT INTO EMP VALUES
(7499, 'ALLEN', 'SALESMAN',7698, CONVERT (date, '20-FEB-1981'), 1600, 300, 30); INSERT INTO EMP VALUES
(7521, 'WARD', 'SALESMAN',7698, CONVERT(date, '22-FEB-1981'), 1250, 500, 30); INSERT INTO EMP VALUES
(7566, 'JONES', 'MANAGER',7839, CONVERT (date, '2-APR-1981'), 2975, NULL, 20); INSERT INTO EMP VALUES
(7654, 'MARTIN', 'SALESMAN',7698, CONVERT (date, '28-SEP-1981'), 1250, 1400, 30); INSERT INTO EMP VALUES
(7698, 'BLAKE', 'MANAGER',7839, CONVERT (date, '1-MAY-1981'), 2850, NULL, 30); INSERT INTO EMP VALUES
(7782, 'CLARK', 'MANAGER', 7839, CONVERT (date, '9-JUN-1981'), 2450, NULL, 10); INSERT INTO EMP VALUES
(7788, 'SCOTT', 'ANALYST',7566, CONVERT (date, '09-DEC-1982'), 3000, NULL, 20); INSERT INTO EMP VALUES
(7839, 'KING', 'PRESIDENT', NULL, CONVERT (date, '17-NOV-1981'), 5000, NULL, 10); INSERT INTO EMP VALUES
(7844, 'TURNER', 'SALESMAN',7698, CONVERT (date, '8-SEP-1981'), 1500, 0, 30); INSERT INTO EMP VALUES
(7876, 'ADAMS', 'CLERK',7788, CONVERT (date, '12-JAN-1983'), 1100, NULL, 20); INSERT INTO EMP VALUES
(7900, 'JAMES', 'CLERK',7698, CONVERT(date, '3-DEC-1981'), 950, NULL, 30); INSERT INTO EMP VALUES
(7902, 'FORD', 'ANALYST',7566, CONVERT (date, '3-DEC-1981'), 3000, NULL, 20); INSERT INTO EMP VALUES
(7934, 'MILLER', 'CLERK',7782, CONVERT (date, '23-JAN-1982'), 1300, NULL, 10);


CREATE TABLE DEPT(
	DEPTNO NUMERIC(2), 
	DNAME VARCHAR(14), 
	LOC VARCHAR(13));


SELECT * from EMP;

INSERT INTO DEPT VALUES (10, 'ACCOUNTING', 'NEW YORK'); 
INSERT INTO DEPT VALUES (20, 'RESEARCH', 'DALLAS'); 
INSERT INTO DEPT VALUES (30, 'SALES', 'CHICAGO'); 
INSERT INTO DEPT VALUES (40, 'OPERATIONS', 'BOSTON');
 
SELECT * from DEPT;

--Task 1
CREATE PROCEDURE MinAvgDept
AS
BEGIN
    SELECT DNAME
    FROM DEPT
    WHERE DEPTNO IN (
        SELECT DEPTINO
        FROM EMP
        GROUP BY DEPTINO
        HAVING AVG(SAL) = (
            SELECT MIN(avg_sal)
            FROM (
                SELECT AVG(SAL) AS avg_sal
                FROM EMP
                GROUP BY DEPTINO
            ) AS avg_sals
        )
    );
END;


EXEC MinAvgDept;

--Task2
CREATE PROCEDURE sal_less_s_salary
    @dept_name VARCHAR(14),
    @max_salary NUMERIC(7,2)
AS
BEGIN
    SELECT *
    FROM EMP e
    JOIN DEPT d ON e.DEPTINO = d.DEPTNO
    WHERE d.DNAME = @dept_name AND e.SAL < @max_salary;
END;

EXEC sal_less_s_salary 'SALES', 2000;

--Task 6
CREATE FUNCTION fn_sum_salaries_by_dept
    (@dept_name VARCHAR(14))
RETURNS NUMERIC(18,2)
AS
BEGIN
    DECLARE @total_sal NUMERIC(18,2);
    SELECT @total_sal = SUM(SAL)
    FROM EMP e
    JOIN DEPT d ON e.DEPTINO = d.DEPTNO
    WHERE d.DNAME = @dept_name;
    RETURN @total_sal;
END;

SELECT dbo.fn_sum_salaries_by_dept('SALES');

